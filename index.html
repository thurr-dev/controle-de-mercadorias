<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Inteligente - Mini Adega</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        :root {
            --bg: #0d0d0d; --card: #1a1a1a; --text: #e0e0e0;
            --primary: #3498db; --success: #27ae60; --danger: #c0392b; --border: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: auto; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        h3 { color: var(--primary); text-align: center; margin-top: 0; }

        #interactive.viewport { width: 100%; height: 200px; border: 2px solid var(--primary); display: none; border-radius: 12px; overflow: hidden; margin-bottom: 10px; }
        
        .carrinho-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .qtd-controles button { padding: 5px 12px; background: #333; border: 1px solid var(--primary); color: white; cursor: pointer; border-radius: 4px; }
        .total-venda { font-size: 1.6em; color: var(--success); text-align: right; padding: 10px; font-weight: bold; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 8px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: #222; border: 1px solid #333; color: white; border-radius: 6px; box-sizing: border-box; }
        
        .historico-dia { border-bottom: 1px solid #333; padding: 10px 0; }
        .data-extenso { color: var(--primary); font-weight: bold; display: block; text-transform: capitalize; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #222; }
        .aviso-estoque { color: #f1c40f; font-weight: bold; animation: pisca 1s infinite; }
        @keyframes pisca { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }
        
        .btn-cal { background: #e67e22; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h3>üè™ Mini Adega & Mercado</h3>

    <div class="card">
        <button class="btn btn-blue" onclick="abrirScanner()">üì∑ ESCANEAR PRODUTO</button>
        <div id="interactive" class="viewport"></div>
        <div id="listaCarrinho"></div>
        <div class="total-venda" id="totalCarrinho">R$ 0,00</div>
        <button class="btn btn-green" id="btnFinalizar" style="display:none;" onclick="concluirVenda()">CONCLUIR VENDA (DESCONTAR)</button>
    </div>

    <div class="card">
        <h3>üì¶ Cadastro de Produto</h3>
        <input type="text" id="cad-ean" placeholder="C√≥digo de Barras">
        <input type="text" id="cad-nome" placeholder="Nome do Produto">
        <input type="number" id="cad-qtd" placeholder="Quantidade em Estoque">
        <input type="number" id="cad-preco" placeholder="Pre√ßo de Venda R$">
        <label style="font-size: 12px; color: #888;">Data de Vencimento:</label>
        <input type="date" id="cad-venc">
        <button class="btn btn-blue" onclick="cadastrarProduto()">SALVAR NO SISTEMA</button>
    </div>

    <div class="card">
        <h3>üìä Vendas por Dia</h3>
        <div id="historicoVendas"></div>
    </div>

    <div class="card">
        <h3>üìã Lista de Estoque</h3>
        <div id="listaEstoque" style="overflow-x:auto;"></div>
    </div>
</div>

<script>
    let estoque = JSON.parse(localStorage.getItem('adega_v6_estoque')) || [];
    let vendasGerais = JSON.parse(localStorage.getItem('adega_v6_vendas')) || [];
    let carrinho = [];
    const WHATSAPP_NUMERO = "5531997371625";

    function abrirScanner() {
        const div = document.getElementById('interactive');
        div.style.display = 'block';
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: div, constraints: { facingMode: "environment" } },
            decoder: { readers: ["ean_reader"] }
        }, err => { if(!err) Quagga.start(); });
    }

    Quagga.onDetected(data => {
        const cod = data.codeResult.code;
        const item = estoque.find(i => i.ean === cod);
        if(item) {
            Quagga.stop(); document.getElementById('interactive').style.display = 'none';
            const existente = carrinho.find(c => c.ean === cod);
            if(existente) existente.qtdVenda++; else carrinho.push({...item, qtdVenda: 1});
            renderCarrinho();
        } else {
            document.getElementById('cad-ean').value = cod;
        }
    });

    function renderCarrinho() {
        const container = document.getElementById('listaCarrinho');
        const btnF = document.getElementById('btnFinalizar');
        container.innerHTML = ''; let total = 0;
        if(carrinho.length > 0) {
            btnF.style.display = 'block';
            carrinho.forEach((item, index) => {
                total += (item.preco * item.qtdVenda);
                container.innerHTML += `
                    <div class="carrinho-item">
                        <span><strong>${item.nome}</strong></span>
                        <div class="qtd-controles">
                            <button onclick="alterarQtd(${index}, -1)">-</button>
                            <span style="padding:0 10px">${item.qtdVenda}</span>
                            <button onclick="alterarQtd(${index}, 1)">+</button>
                        </div>
                        <span>R$ ${(item.preco * item.qtdVenda).toFixed(2)}</span>
                    </div>`;
            });
        } else { btnF.style.display = 'none'; }
        document.getElementById('totalCarrinho').innerText = `R$ ${total.toFixed(2)}`;
    }

    function alterarQtd(index, v) {
        carrinho[index].qtdVenda += v;
        if(carrinho[index].qtdVenda <= 0) carrinho.splice(index, 1);
        renderCarrinho();
    }

    function concluirVenda() {
        const hoje = new Date();
        const dataExtenso = hoje.toLocaleDateString('pt-br', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        let totalVenda = 0;
        let mensagensAlerta = [];

        carrinho.forEach(itemC => {
            const itemE = estoque.find(i => i.ean === itemC.ean);
            if(itemE) {
                itemE.qtd -= itemC.qtdVenda;
                totalVenda += (itemC.preco * itemC.qtdVenda);
                
                if(itemE.qtd <= 5) {
                    mensagensAlerta.push(`‚ùå ESTOQUE BAIXO: *${itemE.nome}* tem apenas ${itemE.qtd} unidades restantes!`);
                }
            }
        });

        vendasGerais.push({ data: dataExtenso, total: totalVenda });
        carrinho = [];
        salvar();
        alert("Venda Finalizada!");

        if(mensagensAlerta.length > 0) {
            const msg = window.encodeURIComponent(mensagensAlerta.join("\n"));
            window.open(`https://wa.me/${WHATSAPP_NUMERO}?text=${msg}`);
        }
    }

    function cadastrarProduto() {
        const p = {
            id: Date.now(),
            ean: document.getElementById('cad-ean').value,
            nome: document.getElementById('cad-nome').value,
            qtd: parseInt(document.getElementById('cad-qtd').value),
            preco: parseFloat(document.getElementById('cad-preco').value),
            venc: document.getElementById('cad-venc').value
        };
        estoque.push(p);
        salvar();
        alert("Produto Registrado!");
        limpar();
    }

    // Fun√ß√£o para Adicionar ao Calend√°rio do Celular
    function addAoCalendario(nome, dataVenc) {
        if(!dataVenc) return alert("Sem data de vencimento!");
        const data = dataVenc.replace(/-/g, '');
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=VENCIMENTO:+${encodeURIComponent(nome)}&dates=${data}/${data}&details=Produto+vencendo+no+estoque&sf=true&output=xml`;
        window.open(url, '_blank');
    }

    function salvar() {
        localStorage.setItem('adega_v6_estoque', JSON.stringify(estoque));
        localStorage.setItem('adega_v6_vendas', JSON.stringify(vendasGerais));
        renderEstoque(); renderHistorico(); renderCarrinho();
    }

    function renderEstoque() {
        const div = document.getElementById('listaEstoque');
        let html = '<table><tr><th>Item</th><th>Qtd</th><th>Venc.</th><th>Agenda</th></tr>';
        estoque.forEach(i => {
            const classeQtd = i.qtd <= 5 ? 'aviso-estoque' : '';
            html += `<tr>
                <td>${i.nome}</td>
                <td class="${classeQtd}">${i.qtd}</td>
                <td>${i.venc ? i.venc.split('-').reverse().join('/') : '--'}</td>
                <td><button class="btn-cal" onclick="addAoCalendario('${i.nome}', '${i.venc}')">üìÖ</button></td>
            </tr>`;
        });
        div.innerHTML = html + '</table>';
    }

    function renderHistorico() {
        const div = document.getElementById('historicoVendas');
        div.innerHTML = '';
        const agrupado = vendasGerais.reduce((acc, v) => {
            acc[v.data] = (acc[v.data] || 0) + v.total;
            return acc;
        }, {});
        for(let data in agrupado) {
            div.innerHTML += `<div class="historico-dia">
                <span class="data-extenso">${data}</span>
                <span style="color:var(--success)">Total: R$ ${agrupado[data].toFixed(2)}</span>
            </div>`;
        }
    }

    function limpar() { document.querySelectorAll('input').forEach(i => i.value = ''); }

    renderEstoque(); renderHistorico();
</script>
</body>
</html>
