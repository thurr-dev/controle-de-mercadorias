<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Adega Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        :root { --bg: #050505; --card: #121212; --primary: #007bff; --success: #28a745; --danger: #dc3545; --text: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .card { background: var(--card); border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        
        /* Ajustes de CÃ¢mera */
        #interactive.viewport { width: 100%; height: 250px; position: relative; overflow: hidden; border-radius: 10px; border: 2px solid var(--primary); display: none; margin-bottom: 10px; }
        #interactive.viewport canvas, video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-bottom: 8px; color: white; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--success); }
        .btn-repor { background: #6c757d; padding: 5px; font-size: 11px; width: auto; margin: 0; }

        input { width: 100%; padding: 10px; margin-bottom: 10px; background: #222; border: 1px solid #444; color: white; box-sizing: border-box; }
        
        .item-carrinho { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding: 8px 0; }
        .total-box { font-size: 1.8em; text-align: right; color: var(--success); margin: 15px 0; border-top: 1px solid #444; padding-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #222; }
        .alerta { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center; color:var(--primary); margin:0 0 10px 0;">PDV - VENDAS</h2>
    <button class="btn btn-blue" onclick="ligarCamera()">ðŸ“· ESCANEAR / ADICIONAR ITEM</button>
    <button class="btn" style="background:#555; font-size:12px;" onclick="ligarCamera()">ðŸ”„ REPARAR FOCO</button>
    <div id="interactive" class="viewport"></div>

    <div id="carrinhoLista">
        <p style="text-align:center; color:#777;">Escaneie itens para somar...</p>
    </div>
    
    <div class="total-box">Total: <span id="valorTotal">R$ 0,00</span></div>
    <button class="btn btn-green" id="btnConcluir" style="display:none;" onclick="fecharVenda()">CONCLUIR VENDA (DESCONTAR ESTOQUE)</button>
</div>

<div class="card">
    <h3>ðŸ“¦ Novo Cadastro / ReposiÃ§Ã£o</h3>
    <input type="text" id="ean" placeholder="CÃ³d. Barras (Escaneie)">
    <input type="text" id="nome" placeholder="Nome do Produto">
    <input type="number" id="qtd" placeholder="Quantidade">
    <input type="number" id="preco" placeholder="PreÃ§o R$">
    <label style="font-size:12px;">Vencimento:</label>
    <input type="date" id="venc">
    <button class="btn btn-blue" onclick="salvarProduto()">SALVAR NO ESTOQUE</button>
</div>

<div class="card">
    <h3>ðŸ“Š HistÃ³rico de Hoje</h3>
    <div id="historicoDia"></div>
</div>

<div class="card">
    <h3>ðŸ“‹ Estoque Atual</h3>
    <div id="estoqueTabela"></div>
</div>

<script>
    let db_estoque = JSON.parse(localStorage.getItem('adega_v7_est')) || [];
    let db_vendas = JSON.parse(localStorage.getItem('adega_v7_ven')) || [];
    let carrinho = [];
    const WHATS = "5531997371625";

    // SOM DE CONFIRMAÃ‡ÃƒO
    function tocarBip() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = 880; gain.gain.value = 0.1;
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    // CAMERA E SCANNER
    function ligarCamera() {
        document.getElementById('interactive').style.display = 'block';
        Quagga.init({
            inputStream: { 
                name: "Live", type: "LiveStream", target: "#interactive",
                constraints: { facingMode: "environment", focusMode: "continuous" }
            },
            decoder: { readers: ["ean_reader", "ean_8_reader"] },
            locate: true
        }, (err) => {
            if (err) return alert("Erro na cÃ¢mera");
            Quagga.start();
        });
    }

    Quagga.onDetected(res => {
        const code = res.codeResult.code;
        const p = db_estoque.find(i => i.ean === code);
        tocarBip();
        
        if(p) {
            const noCarrinho = carrinho.find(c => c.ean === code);
            if(noCarrinho) noCarrinho.qtdVenda++; else carrinho.push({...p, qtdVenda: 1});
            renderCarrinho();
        } else {
            document.getElementById('ean').value = code;
            alert("Produto nÃ£o cadastrado! Preencha os dados abaixo.");
            Quagga.stop();
            document.getElementById('interactive').style.display = 'none';
        }
    });

    function renderCarrinho() {
        const lista = document.getElementById('carrinhoLista');
        const btn = document.getElementById('btnConcluir');
        lista.innerHTML = ''; let total = 0;
        
        carrinho.forEach((item, idx) => {
            total += (item.preco * item.qtdVenda);
            lista.innerHTML += `
                <div class="item-carrinho">
                    <span>${item.nome} (x${item.qtdVenda})</span>
                    <span>R$ ${(item.preco * item.qtdVenda).toFixed(2)} 
                    <button onclick="removerDoCarrinho(${idx})" style="color:red; background:none; border:none; margin-left:10px;">X</button></span>
                </div>`;
        });
        document.getElementById('valorTotal').innerText = `R$ ${total.toFixed(2)}`;
        btn.style.display = carrinho.length > 0 ? 'block' : 'none';
    }

    function removerDoCarrinho(idx) { carrinho.splice(idx, 1); renderCarrinho(); }

    // DESCONTAR ESTOQUE E FINALIZAR
    function fecharVenda() {
        let alertas = [];
        const hoje = new Date();
        const dataExtenso = hoje.toLocaleDateString('pt-br', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        let totalFinal = 0;

        carrinho.forEach(itemC => {
            const itemE = db_estoque.find(i => i.ean === itemC.ean);
            if(itemE) {
                itemE.qtd -= itemC.qtdVenda;
                totalFinal += (itemC.preco * itemC.qtdVenda);
                if(itemE.qtd <= 5) alertas.push(`ðŸš¨ *${itemE.nome}* ACABANDO! Restam ${itemE.qtd} unidades.`);
            }
        });

        db_vendas.push({ data: dataExtenso, valor: totalFinal });
        carrinho = [];
        salvar();
        alert("Venda registrada!");

        if(alertas.length > 0) {
            window.open(`https://wa.me/${WHATS}?text=${window.encodeURIComponent(alertas.join("\n"))}`);
        }
    }

    // REPOSIÃ‡ÃƒO DE ESTOQUE
    function reporEstoque(ean) {
        const qtdNova = prompt("Quantos itens vocÃª estÃ¡ adicionando ao estoque?");
        if(qtdNova) {
            const p = db_estoque.find(i => i.ean === ean);
            p.qtd += parseInt(qtdNova);
            salvar();
        }
    }

    function salvarProduto() {
        const ean = document.getElementById('ean').value;
        const nome = document.getElementById('nome').value;
        const qtd = parseInt(document.getElementById('qtd').value);
        const preco = parseFloat(document.getElementById('preco').value);
        const venc = document.getElementById('venc').value;

        if(!ean || !nome) return alert("Preencha EAN e Nome!");
        
        db_estoque.push({ ean, nome, qtd, preco, venc });
        salvar();
        alert("Produto salvo!");
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function salvar() {
        localStorage.setItem('adega_v7_est', JSON.stringify(db_estoque));
        localStorage.setItem('adega_v7_ven', JSON.stringify(db_vendas));
        renderEstoque();
        renderHistorico();
        renderCarrinho();
    }

    function renderEstoque() {
        const div = document.getElementById('estoqueTabela');
        let h = '<table><tr><th>Item</th><th>Qtd</th><th>AÃ§Ã£o</th></tr>';
        db_estoque.forEach(i => {
            h += `<tr>
                <td>${i.nome}<br><small>${i.venc || 'S/ Data'}</small></td>
                <td class="${i.qtd <= 5 ? 'alerta' : ''}">${i.qtd}</td>
                <td><button class="btn-repor" onclick="reporEstoque('${i.ean}')">REPOR</button></td>
            </tr>`;
        });
        div.innerHTML = h + '</table>';
    }

    function renderHistorico() {
        const div = document.getElementById('historicoDia');
        div.innerHTML = '';
        const agrupar = db_vendas.reduce((acc, v) => {
            acc[v.data] = (acc[v.data] || 0) + v.valor;
            return acc;
        }, {});
        for(let data in agrupar) {
            div.innerHTML += `<p><strong>${data}</strong><br><span style="color:var(--success)">Faturado: R$ ${agrupar[data].toFixed(2)}</span></p>`;
        }
    }

    renderEstoque();
    renderHistorico();
</script>
</body>
</html>
