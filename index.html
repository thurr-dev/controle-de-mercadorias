<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adega Pro - Painel de Controle</title>
    
    <meta name="theme-color" content="#0d0d0d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mini Adega">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/thurr-dev/controle-de-mercadorias/main/icone2.png">
    <link rel="manifest" id="pwa-manifest">

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --bg: #0d0d0d; --card: #1a1a1a; --primary: #3498db; --success: #2ecc71; --danger: #e74c3c; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .card { background: var(--card); border: 1px solid #333; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; display: none; margin-bottom: 10px; border: 2px solid var(--primary) !important; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; font-size: 14px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--success); }
        .btn-pdf { background: #8e44ad; }
        .btn-excel { background: #27ae60; }
        .btn-acao { padding: 8px; font-size: 12px; width: auto; margin: 0 2px; border-radius: 4px; border: none; color: white; cursor: pointer; }
        .btn-edit { background: #f39c12; }
        .btn-del { background: #e74c3c; }
        input { width: 100%; padding: 14px; background: #252525; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        .total-venda { font-size: 1.8em; text-align: right; color: var(--success); margin: 15px 0; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #222; }
        .alerta-estoque { color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center; margin:0 0 15px 0;">üõí Frente de Caixa</h2>
    <button class="btn btn-blue" onclick="iniciarLeitor()">üì∑ ESCANEAR PRODUTO</button>
    <div id="reader"></div>
    <div id="carrinhoLista"></div>
    <div class="total-venda">Total: <span id="valorTotal">R$ 0,00</span></div>
    <button class="btn btn-green" id="btnFinalizar" style="display:none;" onclick="finalizarVenda()">CONCLUIR VENDA</button>
</div>

<div class="card">
    <h3>üìÇ Exportar Vendas (Backup)</h3>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-pdf" onclick="gerarPDF()">üìÑ PDF</button>
        <button class="btn btn-excel" onclick="gerarExcel()">üìä EXCEL</button>
    </div>
</div>

<div class="card">
    <h3>üì¶ Cadastro de Produto</h3>
    <input type="text" id="cad-ean" placeholder="C√≥digo de Barras" readonly style="background:#111; color:#666;">
    <input type="text" id="cad-nome" placeholder="Nome do Produto">
    <input type="number" id="cad-qtd" placeholder="Qtd em Estoque">
    <input type="number" id="cad-preco" placeholder="Pre√ßo R$">
    <label style="font-size:12px; color:var(--primary); font-weight:bold;">VENCIMENTO (DD/MM/AAAA):</label>
    <input type="text" id="cad-venc" placeholder="Ex: 10/05/2026" maxlength="10" onkeyup="mascaraData(this)">
    <button class="btn btn-blue" onclick="salvarProduto()">CADASTRAR PRODUTO</button>
</div>

<div class="card">
    <h3>üìã Estoque & Validade</h3>
    <div id="listaEstoque" style="overflow-x:auto;"></div>
</div>

<script>
    /* --- CONFIGURA√á√ÉO PWA AUTOM√ÅTICA --- */
    const appName = "Mini Adega";
    const appIcon = "https://raw.githubusercontent.com/thurr-dev/controle-de-mercadorias/main/icone2.png";

    const manifest = {
        "name": "PAINEL DE CONTROLE DA MINI ADEGA",
        "short_name": "Mini Adega",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#0d0d0d",
        "theme_color": "#3498db",
        "icons": [
            { "src": appIcon, "sizes": "192x192", "type": "image/png" },
            { "src": appIcon, "sizes": "512x512", "type": "image/png" }
        ]
    };

    const manifestStr = JSON.stringify(manifest);
    const blob = new Blob([manifestStr], {type: 'application/json'});
    document.getElementById('pwa-manifest').setAttribute('href', URL.createObjectURL(blob));

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
            self.addEventListener('fetch', function(event) {});
        `));
    }

    /* --- L√ìGICA DO SISTEMA --- */
    const KEY_ESTOQUE = 'adega_master_estoque';
    const KEY_VENDAS = 'adega_master_vendas';

    function migrarDados() {
        let estoqueMigrado = JSON.parse(localStorage.getItem(KEY_ESTOQUE)) || [];
        let vendasMigradas = JSON.parse(localStorage.getItem(KEY_VENDAS)) || [];
        const versoes = ['adega_v7','adega_v8','adega_v9','adega_v10','adega_v11','adega_v12','adega_v13','adega_v14'];
        versoes.forEach(v => {
            let estAntigo = JSON.parse(localStorage.getItem(v + '_est'));
            let venAntigo = JSON.parse(localStorage.getItem(v + '_ven'));
            if(estAntigo) {
                estAntigo.forEach(p => { if(!estoqueMigrado.find(x => x.ean === p.ean)) estoqueMigrado.push(p); });
                localStorage.removeItem(v + '_est');
            }
            if(venAntigo) {
                vendasMigradas = [...vendasMigradas, ...venAntigo];
                localStorage.removeItem(v + '_ven');
            }
        });
        localStorage.setItem(KEY_ESTOQUE, JSON.stringify(estoqueMigrado));
        localStorage.setItem(KEY_VENDAS, JSON.stringify(vendasMigradas));
        return { estoqueMigrado, vendasMigradas };
    }

    const dadosIniciais = migrarDados();
    let estoque = dadosIniciais.estoqueMigrado;
    let vendas = dadosIniciais.vendasMigradas;
    let carrinho = [];
    let html5QrCode;
    const NUMERO_ZAP = "5511988207302";

    function mascaraData(i) {
        let v = i.value.replace(/\D/g, '');
        if (v.length > 2) v = v.substring(0,2) + '/' + v.substring(2);
        if (v.length > 5) v = v.substring(0,5) + '/' + v.substring(5,9);
        i.value = v;
    }

    function bip() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = 1000; gain.gain.value = 0.1;
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function iniciarLeitor() {
        document.getElementById('reader').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (codigo) => {
            bip();
            html5QrCode.stop().then(() => {
                document.getElementById('reader').style.display = 'none';
                processarLeitura(codigo);
            });
        });
    }

    function processarLeitura(codigo) {
        const produto = estoque.find(i => i.ean === codigo);
        if (produto) {
            const qtd = prompt(`Produto: ${produto.nome}\nQuantas unidades?`, "1");
            if (qtd && parseInt(qtd) > 0) {
                const noCarrinho = carrinho.find(c => c.ean === codigo);
                if (noCarrinho) noCarrinho.qtdVenda += parseInt(qtd); else carrinho.push({...produto, qtdVenda: parseInt(qtd)});
                renderCarrinho();
            }
        } else {
            document.getElementById('cad-ean').value = codigo;
            alert("Novo produto! Complete o cadastro.");
        }
    }

    function renderCarrinho() {
        const div = document.getElementById('carrinhoLista');
        div.innerHTML = ''; let total = 0;
        carrinho.forEach((item, idx) => {
            total += (item.preco * item.qtdVenda);
            div.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333;">
                <span>${item.nome} (x${item.qtdVenda})</span>
                <span>R$ ${(item.preco * item.qtdVenda).toFixed(2)} <button onclick="carrinho.splice(${idx},1);renderCarrinho();" style="color:red;background:none;border:none;">X</button></span>
            </div>`;
        });
        document.getElementById('valorTotal').innerText = `R$ ${total.toFixed(2)}`;
        document.getElementById('btnFinalizar').style.display = carrinho.length > 0 ? 'block' : 'none';
    }

    function finalizarVenda() {
        let alertas = [];
        const dataH = new Date().toLocaleDateString('pt-br', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        let totalV = 0;
        carrinho.forEach(c => {
            const e = estoque.find(i => i.ean === c.ean);
            if(e) {
                e.qtd -= c.qtdVenda;
                totalV += (c.preco * c.qtdVenda);
                if(e.qtd <= 5) alertas.push(`üö® *${e.nome}* ACABANDO! Restam ${e.qtd}.`);
            }
        });
        vendas.push({ data: dataH, valor: totalV, timestamp: new Date().toISOString() });
        carrinho = [];
        salvar();
        alert("Venda realizada!");
        if(alertas.length > 0) window.open(`https://wa.me/${NUMERO_ZAP}?text=${window.encodeURIComponent(alertas.join("\n"))}`);
    }

    function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("RELATORIO DE VENDAS - ADEGA", 20, 20);
        let y = 35;
        vendas.forEach(v => {
            if(y > 280) { doc.addPage(); y = 20; }
            doc.text(`${v.data}: R$ ${v.valor.toFixed(2)}`, 20, y);
            y += 10;
        });
        doc.save("vendas_adega.pdf");
    }

    function gerarExcel() {
        const ws = XLSX.utils.json_to_sheet(vendas);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Vendas");
        XLSX.writeFile(wb, "vendas_adega.xlsx");
    }

    function editarProduto(ean) {
        const p = estoque.find(i => i.ean === ean);
        if(p) {
            p.nome = prompt("Nome:", p.nome) || p.nome;
            p.qtd = parseInt(prompt("Quantidade:", p.qtd));
            p.preco = parseFloat(prompt("Pre√ßo:", p.preco));
            p.venc = prompt("Vencimento (DD/MM/AAAA):", p.venc);
            salvar();
        }
    }

    function salvarProduto() {
        const p = {
            ean: document.getElementById('cad-ean').value,
            nome: document.getElementById('cad-nome').value,
            qtd: parseInt(document.getElementById('cad-qtd').value) || 0,
            preco: parseFloat(document.getElementById('cad-preco').value) || 0,
            venc: document.getElementById('cad-venc').value
        };
        if(!p.ean || !p.nome) return alert("Preencha Nome e C√≥digo!");
        estoque.push(p);
        salvar();
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function salvar() {
        localStorage.setItem(KEY_ESTOQUE, JSON.stringify(estoque));
        localStorage.setItem(KEY_VENDAS, JSON.stringify(vendas));
        renderEstoque();
        renderCarrinho();
    }

    function renderEstoque() {
        const div = document.getElementById('listaEstoque');
        let html = '<table><tr><th>Item</th><th>Qtd</th><th>A√ß√µes</th></tr>';
        estoque.forEach(i => {
            html += `<tr>
                <td><strong>${i.nome}</strong><br><small>Val: ${i.venc || '---'}</small></td>
                <td class="${i.qtd <= 5 ? 'alerta-estoque' : ''}">${i.qtd}</td>
                <td>
                    <div style="display:flex; gap:3px;">
                        <button class="btn-acao btn-edit" onclick="editarProduto('${i.ean}')">‚úèÔ∏è</button>
                        <button class="btn-acao btn-del" onclick="estoque=estoque.filter(x=>x.ean!=='${i.ean}');salvar();">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>`;
        });
        div.innerHTML = html + '</table>';
    }

    renderEstoque();
</script>
</body>
</html>
