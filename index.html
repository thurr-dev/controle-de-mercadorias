<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado - Mini Adega</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        :root {
            --bg: #0d0d0d; --card: #1a1a1a; --text: #e0e0e0;
            --primary: #3498db; --success: #27ae60; --danger: #c0392b; --border: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: auto; }
        
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        h2, h3 { color: var(--primary); text-align: center; }

        /* Scanner */
        #interactive.viewport { width: 100%; height: 250px; border: 2px solid var(--primary); display: none; border-radius: 12px; overflow: hidden; margin-bottom: 10px; }

        /* Carrinho de Vendas */
        .carrinho-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .qtd-controles button { padding: 5px 10px; background: #333; border: 1px solid var(--primary); color: white; cursor: pointer; }
        .total-venda { font-size: 1.5em; color: var(--success); text-align: right; padding: 15px; font-weight: bold; }

        /* Bot√µes */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 10px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-whatsapp { background: #25d366; color: white; font-size: 12px; padding: 5px; width: auto; }

        /* Hist√≥rico */
        .data-extenso { color: var(--primary); font-weight: bold; margin-top: 15px; display: block; text-transform: capitalize; }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 12px; text-align: left; border-bottom: 1px solid #222; }

        .aviso { color: #f1c40f; font-size: 0.8em; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>üè™ Gest√£o & Vendas</h2>

    <div class="card">
        <button class="btn btn-blue" onclick="abrirScanner()">üì∑ ESCANEAR PRODUTO</button>
        <div id="interactive" class="viewport"></div>

        <h3>üõí Carrinho de Venda</h3>
        <div id="listaCarrinho">
            <p style="text-align:center; color:#666;">Passe um produto para iniciar a lista...</p>
        </div>
        <div class="total-venda" id="totalCarrinho">R$ 0,00</div>
        <button class="btn btn-green" id="btnFinalizar" style="display:none;" onclick="concluirVenda()">CONCLUIR E DESCONTAR ESTOQUE</button>
    </div>

    <div class="card">
        <h3>üì¶ Cadastro / Estoque</h3>
        <input type="text" id="cad-ean" placeholder="C√≥d. Barras" style="width:95%; padding:10px; margin-bottom:10px; background:#222; border:1px solid #333; color:white;">
        <input type="text" id="cad-nome" placeholder="Nome do Produto" style="width:95%; padding:10px; margin-bottom:10px; background:#222; border:1px solid #333; color:white;">
        <input type="number" id="cad-qtd" placeholder="Qtd Inicial" style="width:45%; padding:10px; background:#222; border:1px solid #333; color:white;">
        <input type="number" id="cad-preco" placeholder="Pre√ßo R$" style="width:45%; padding:10px; background:#222; border:1px solid #333; color:white;">
        <button class="btn btn-blue" style="margin-top:10px;" onclick="cadastrarProduto()">SALVAR NO ESTOQUE</button>
    </div>

    <div class="card">
        <h3>üìä Hist√≥rico de Vendas (Por Dia)</h3>
        <div id="historicoVendas"></div>
    </div>

    <div class="card">
        <h3>üìã Produtos em Estoque</h3>
        <div id="listaEstoque"></div>
    </div>
</div>

<script>
    let estoque = JSON.parse(localStorage.getItem('adega_estoque_v5')) || [];
    let vendasGerais = JSON.parse(localStorage.getItem('adega_vendas_v5')) || [];
    let carrinho = [];

    const WHATSAPP_NUMERO = "5531997371625";

    // Fun√ß√µes de √Åudio
    function bip() {
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.1);
    }

    // Scanner
    function abrirScanner() {
        const div = document.getElementById('interactive');
        div.style.display = 'block';
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: div, constraints: { facingMode: "environment" } },
            decoder: { readers: ["ean_reader"] }
        }, err => { if(!err) Quagga.start(); });
    }

    Quagga.onDetected(data => {
        const cod = data.codeResult.code;
        const item = estoque.find(i => i.ean === cod);
        if(item) {
            bip();
            Quagga.stop();
            document.getElementById('interactive').style.display = 'none';
            adicionarAoCarrinho(item);
        } else {
            document.getElementById('cad-ean').value = cod;
        }
    });

    // L√≥gica do Carrinho
    function adicionarAoCarrinho(produto) {
        const existente = carrinho.find(c => c.ean === produto.ean);
        if(existente) {
            existente.qtdVenda++;
        } else {
            carrinho.push({...produto, qtdVenda: 1});
        }
        renderCarrinho();
    }

    function alterarQtdCarrinho(index, valor) {
        carrinho[index].qtdVenda += valor;
        if(carrinho[index].qtdVenda <= 0) carrinho.splice(index, 1);
        renderCarrinho();
    }

    function renderCarrinho() {
        const container = document.getElementById('listaCarrinho');
        const btnF = document.getElementById('btnFinalizar');
        container.innerHTML = '';
        let total = 0;

        if(carrinho.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#666;">Carrinho vazio.</p>';
            btnF.style.display = 'none';
        } else {
            btnF.style.display = 'block';
            carrinho.forEach((item, index) => {
                total += (item.preco * item.qtdVenda);
                container.innerHTML += `
                    <div class="carrinho-item">
                        <div>
                            <strong>${item.nome}</strong><br>
                            <small>R$ ${item.preco.toFixed(2)} un.</small>
                        </div>
                        <div class="qtd-controles">
                            <button onclick="alterarQtdCarrinho(${index}, -1)">-</button>
                            <span style="margin: 0 10px">${item.qtdVenda}</span>
                            <button onclick="alterarQtdCarrinho(${index}, 1)">+</button>
                        </div>
                        <div>R$ ${(item.preco * item.qtdVenda).toFixed(2)}</div>
                    </div>`;
            });
        }
        document.getElementById('totalCarrinho').innerText = `R$ ${total.toFixed(2)}`;
    }

    // Finalizar Venda e Notificar
    function concluirVenda() {
        const hoje = new Date();
        const dataFormatada = hoje.toLocaleDateString('pt-br', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        let totalVenda = 0;
        let alertas = [];

        carrinho.forEach(itemCarrinho => {
            const itemEstoque = estoque.find(i => i.ean === itemCarrinho.ean);
            if(itemEstoque) {
                itemEstoque.qtd -= itemCarrinho.qtdVenda;
                totalVenda += (itemCarrinho.preco * itemCarrinho.qtdVenda);
                
                // Verificar Estoque Baixo para Alerta
                if(itemEstoque.qtd <= 3) {
                    alertas.push(`‚ö†Ô∏è O produto *${itemEstoque.nome}* est√° acabando! Restam apenas ${itemEstoque.qtd} no estoque.`);
                }
            }
        });

        // Registrar no Hist√≥rico
        vendasGerais.push({ data: dataFormatada, total: totalVenda, itens: carrinho.length });
        
        // Resetar Carrinho
        carrinho = [];
        salvarTudo();
        alert("Venda registrada e estoque atualizado!");

        // Enviar alertas via WhatsApp se houver
        if(alertas.length > 0) {
            const msg = window.encodeURIComponent(alertas.join("\n"));
            window.open(`https://wa.me/${WHATSAPP_NUMERO}?text=${msg}`);
        }
    }

    // Gerenciamento de Dados
    function cadastrarProduto() {
        const p = {
            ean: document.getElementById('cad-ean').value,
            nome: document.getElementById('cad-nome').value,
            qtd: parseInt(document.getElementById('cad-qtd').value),
            preco: parseFloat(document.getElementById('cad-preco').value)
        };
        estoque.push(p);
        salvarTudo();
        alert("Produto salvo!");
    }

    function salvarTudo() {
        localStorage.setItem('adega_estoque_v5', JSON.stringify(estoque));
        localStorage.setItem('adega_vendas_v5', JSON.stringify(vendasGerais));
        renderEstoque();
        renderHistorico();
        renderCarrinho();
    }

    function renderEstoque() {
        const div = document.getElementById('listaEstoque');
        div.innerHTML = '<table><tr><th>Produto</th><th>Estoque</th><th>Pre√ßo</th></tr>';
        estoque.forEach(i => {
            div.innerHTML += `<tr>
                <td>${i.nome}<br><small>${i.ean}</small></td>
                <td class="${i.qtd <= 3 ? 'aviso' : ''}">${i.qtd} un.</td>
                <td>R$ ${i.preco.toFixed(2)}</td>
            </tr>`;
        });
        div.innerHTML += '</table>';
    }

    function renderHistorico() {
        const div = document.getElementById('historicoVendas');
        div.innerHTML = '';
        
        // Agrupar por data
        const resumo = vendasGerais.reduce((acc, v) => {
            acc[v.data] = (acc[v.data] || 0) + v.total;
            return acc;
        }, {});

        for(let data in resumo) {
            div.innerHTML += `
                <div style="border-bottom:1px solid #333; padding:10px 0;">
                    <span class="data-extenso">${data}</span>
                    <span style="color:var(--success)">Faturamento: R$ ${resumo[data].toFixed(2)}</span>
                </div>`;
        }
    }

    // Inicializa√ß√£o
    renderEstoque();
    renderHistorico();
</script>
</body>
</html>
