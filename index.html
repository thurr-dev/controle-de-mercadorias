<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Profissional - Entrada Manual</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #eee; --primary: #3498db; --success: #2ecc71; --border: #333; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        
        input, button { padding: 14px; background: #252525; border: 1px solid var(--border); border-radius: 8px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        label { display: block; text-align: left; margin-bottom: 5px; font-size: 13px; color: #888; }
        .btn-blue { background: var(--primary); font-weight: bold; border: none; cursor: pointer; }
        .btn-green { background: var(--success); font-weight: bold; border: none; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; color: #888; padding-bottom: 10px; }
        td { padding: 10px 0; border-bottom: 1px solid var(--border); }
        .btn-cal { background: none; border: 1px solid var(--warning); color: var(--warning); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; width: auto; margin-top: 5px; }

        #toast { visibility: hidden; background: var(--success); color: #fff; text-align: center; border-radius: 8px; padding: 15px; position: fixed; z-index: 100; left: 50%; bottom: 20px; transform: translateX(-50%); }
        #toast.show { visibility: visible; }
        #interactive.viewport { width: 100%; height: 200px; display: none; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="toast">‚úÖ Opera√ß√£o Realizada!</div>
    <h2 style="text-align:center; color:var(--primary);">üè™ PDV com Validade</h2>

    <button class="btn-blue" onclick="abrirScanner()">üì∑ ESCANEAR C√ìDIGO</button>
    <div id="interactive" class="viewport"></div>

    <div class="card">
        <h4>üì¶ Cadastrar Produto</h4>
        <input type="text" id="ean" placeholder="C√≥digo de Barras">
        <input type="text" id="nome" placeholder="Nome do Produto">
        <input type="number" id="estoque-inicial" placeholder="Quantidade">
        <input type="number" id="preco-venda" placeholder="Pre√ßo R$">
        
        <label>Vencimento (DD/MM/AAAA):</label>
        <input type="text" id="data-vencimento" placeholder="Ex: 31/12/2026" maxlength="10" onkeyup="mascaraData(this)">
        
        <button class="btn-blue" onclick="cadastrar()">CADASTRAR PRODUTO</button>
    </div>

    <div class="card">
        <h4>üìã Estoque & Validade</h4>
        <table>
            <thead><tr><th>Produto/Venc.</th><th>Qtd</th><th>A√ß√µes</th></tr></thead>
            <tbody id="listaProdutos"></tbody>
        </table>
    </div>
</div>

<script>
    let estoque = JSON.parse(localStorage.getItem('loja_estoque')) || [];

    // M√°scara para digitar a data com barras automaticamente
    function mascaraData(campo) {
        let v = campo.value.replace(/\D/g, ""); // Remove tudo que n√£o √© n√∫mero
        if (v.length >= 3 && v.length <= 4) campo.value = v.substring(0, 2) + "/" + v.substring(2);
        if (v.length >= 5) campo.value = v.substring(0, 2) + "/" + v.substring(2, 4) + "/" + v.substring(4, 8);
    }

    function cadastrar() {
        const dataInput = document.getElementById('data-vencimento').value;
        
        // Valida√ß√£o simples de data
        if(dataInput.length > 0 && dataInput.length < 10) {
            alert("Digite a data completa: DD/MM/AAAA");
            return;
        }

        const item = {
            id: Date.now(),
            ean: document.getElementById('ean').value,
            nome: document.getElementById('nome').value,
            qtd: parseInt(document.getElementById('estoque-inicial').value) || 0,
            preco: parseFloat(document.getElementById('preco-venda').value) || 0,
            vencimento: dataInput // Salva como string digitada
        };
        
        if(!item.nome) { alert("Nome √© obrigat√≥rio"); return; }
        
        estoque.push(item);
        salvar();
        limparCampos();
    }

    // Fun√ß√£o para adicionar ao Calend√°rio do Google
    function addCalendario(nome, dataPtBR) {
        try {
            // Converte DD/MM/AAAA para AAAAMMDD
            const partes = dataPtBR.split('/');
            const dataFormatada = partes[2] + partes[1] + partes[0];
            
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=VENCIMENTO:+${encodeURIComponent(nome)}&dates=${dataFormatada}/${dataFormatada}&details=Produto+vencendo+no+estoque&sf=true&output=xml`;
            
            window.open(url, '_blank');
        } catch(e) {
            alert("Erro ao gerar link do calend√°rio. Verifique se a data est√° correta.");
        }
    }

    function salvar() {
        localStorage.setItem('loja_estoque', JSON.stringify(estoque));
        renderizar();
    }

    function renderizar() {
        const corpo = document.getElementById('listaProdutos');
        corpo.innerHTML = '';
        estoque.forEach(i => {
            corpo.innerHTML += `<tr>
                <td>
                    <strong>${i.nome}</strong><br>
                    <small style="color:${checarVencimento(i.vencimento) ? 'red' : '#888'}">Venc: ${i.vencimento || '---'}</small><br>
                    ${i.vencimento ? `<button class="btn-cal" onclick="addCalendario('${i.nome}', '${i.vencimento}')">üìÖ Add Agenda</button>` : ''}
                </td>
                <td>${i.qtd}</td>
                <td><button onclick="remover(${i.id})" style="background:none; border:none; color:red; cursor:pointer; font-size:18px;">üóëÔ∏è</button></td>
            </tr>`;
        });
    }

    // Fun√ß√£o b√¥nus: avisa se a data digitada j√° passou ou est√° perto
    function checarVencimento(dataStr) {
        if(!dataStr) return false;
        const partes = dataStr.split('/');
        const dataVenc = new Date(partes[2], partes[1] - 1, partes[0]);
        return dataVenc < new Date();
    }

    function remover(id) {
        if(confirm("Excluir produto?")) {
            estoque = estoque.filter(i => i.id !== id);
            salvar();
        }
    }

    function limparCampos() {
        document.querySelectorAll('input').forEach(i => i.value = '');
        const t = document.getElementById('toast');
        t.className = "show"; setTimeout(() => t.className = "", 3000);
    }

    // Fun√ß√µes do Scanner (Mantidas)
    function abrirScanner() {
        document.getElementById('interactive').style.display = 'block';
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { facingMode: "environment" } },
            decoder: { readers: ["ean_reader"] }
        }, err => { if(!err) Quagga.start(); });
    }

    Quagga.onDetected(data => {
        document.getElementById('ean').value = data.codeResult.code;
        Quagga.stop();
        document.getElementById('interactive').style.display = 'none';
        document.getElementById('nome').focus();
    });

    renderizar();
</script>
</body>
</html>
