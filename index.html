<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Adega - Scanner Restaurado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --text: #eee; --primary: #3498db; --success: #2ecc71; --border: #333; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; }
        
        /* Ajuste do Scanner para melhor precis√£o */
        #interactive.viewport { 
            width: 100%; height: 300px; border: 2px solid var(--primary); 
            display: none; border-radius: 15px; overflow: hidden; position: relative;
            background: #000;
        }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
        canvas.drawingBuffer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        input, button { padding: 14px; background: #222; border: 1px solid var(--border); border-radius: 8px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .btn-blue { background: var(--primary); font-weight: bold; border: none; cursor: pointer; }
        .btn-green { background: var(--success); font-weight: bold; border: none; cursor: pointer; }
        
        #modal-venda { display: none; background: #222; padding: 20px; border-radius: 12px; border: 2px solid var(--success); text-align: center; }
        .btn-cal { color: var(--warning); border: 1px solid var(--warning); padding: 5px; text-decoration: none; display: inline-block; font-size: 12px; margin-top: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:var(--primary);">üè™ Sistema de Vendas</h2>

    <button class="btn-blue" onclick="abrirScanner()">üì∑ ESCANEAR C√ìDIGO</button>
    <div id="interactive" class="viewport"></div>

    <div id="modal-venda" class="card">
        <h3 id="venda-nome" style="color:var(--success); margin:0;"></h3>
        <p id="venda-preco" style="color:#888;"></p>
        <input type="number" id="venda-qtd" value="1" min="1" style="text-align:center; font-size:20px;">
        <button class="btn-green" onclick="confirmarBaixa()">CONFIRMAR VENDA</button>
        <button onclick="cancelarVenda()" style="background:none; border:none; color:#777; cursor:pointer;">Cancelar</button>
    </div>

    <div class="card">
        <h4>üì¶ Cadastro</h4>
        <input type="text" id="ean" placeholder="C√≥digo de Barras">
        <input type="text" id="nome" placeholder="Produto">
        <input type="number" id="estoque-inicial" placeholder="Qtd">
        <input type="number" id="preco-venda" placeholder="Pre√ßo R$">
        <label style="font-size:12px; color:var(--primary)">VENCIMENTO:</label>
        <input type="date" id="vencimento">
        <button class="btn-blue" onclick="cadastrar()">CADASTRAR</button>
    </div>

    <div class="card">
        <h4>üìã Estoque Atual</h4>
        <table style="width:100%; border-collapse: collapse;">
            <tbody id="listaProdutos"></tbody>
        </table>
    </div>

    <div class="card">
        <h4>üìä Relat√≥rio</h4>
        <button class="btn-blue" onclick="gerarRelatorioPDF()">BAIXAR RELAT√ìRIO PDF</button>
    </div>
</div>

<script>
    let estoque = JSON.parse(localStorage.getItem('adega_v6')) || [];
    let vendas = JSON.parse(localStorage.getItem('vendas_v6')) || [];
    let produtoEncontrado = null;

    function abrirScanner() {
        const scannerDiv = document.getElementById('interactive');
        scannerDiv.style.display = 'block';
        
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: scannerDiv,
                constraints: {
                    width: { min: 640 },
                    height: { min: 480 },
                    facingMode: "environment",
                    aspectRatio: { min: 1, max: 2 }
                }
            },
            locator: { patchSize: "medium", halfSample: true },
            decoder: { readers: ["ean_reader"] }, // Foco total em c√≥digos de barra de mercado
            locate: true
        }, (err) => {
            if (err) return console.error(err);
            Quagga.start();
        });
    }

    Quagga.onDetected((data) => {
        const code = data.codeResult.code;
        produtoEncontrado = estoque.find(i => i.ean === code);
        
        if (produtoEncontrado) {
            Quagga.stop();
            document.getElementById('interactive').style.display = 'none';
            document.getElementById('modal-venda').style.display = 'block';
            document.getElementById('venda-nome').innerText = produtoEncontrado.nome;
            document.getElementById('venda-preco').innerText = "R$ " + produtoEncontrado.preco.toFixed(2);
        } else {
            document.getElementById('ean').value = code;
        }
    });

    function confirmarBaixa() {
        const qtd = parseInt(document.getElementById('venda-qtd').value);
        if (produtoEncontrado.qtd >= qtd) {
            produtoEncontrado.qtd -= qtd;
            vendas.push({ data: new Date().toLocaleDateString(), item: produtoEncontrado.nome, qtd, total: produtoEncontrado.preco * qtd });
            salvar();
            cancelarVenda();
        } else { alert("Sem estoque!"); }
    }

    function cadastrar() {
        const item = {
            id: Date.now(),
            ean: document.getElementById('ean').value,
            nome: document.getElementById('nome').value,
            qtd: parseInt(document.getElementById('estoque-inicial').value) || 0,
            preco: parseFloat(document.getElementById('preco-venda').value) || 0,
            vencimento: document.getElementById('vencimento').value
        };
        estoque.push(item);
        salvar();
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function salvar() {
        localStorage.setItem('adega_v6', JSON.stringify(estoque));
        localStorage.setItem('vendas_v6', JSON.stringify(vendas));
        renderizar();
    }

    function renderizar() {
        const corpo = document.getElementById('listaProdutos');
        corpo.innerHTML = '';
        estoque.forEach(i => {
            const dataVenc = i.vencimento ? i.vencimento.split('-').reverse().join('/') : '---';
            const linkCal = i.vencimento ? `<a href="https://www.google.com/calendar/render?action=TEMPLATE&text=VENCIMENTO:+${i.nome}&dates=${i.vencimento.replace(/-/g,'')}/${i.vencimento.replace(/-/g,'')}" target="_blank" class="btn-cal">üìÖ Alerta</a>` : '';
            
            corpo.innerHTML += `<tr style="border-bottom: 1px solid #333">
                <td style="padding:10px"><strong>${i.nome}</strong><br><small>Venc: ${dataVenc}</small> ${linkCal}</td>
                <td style="text-align:right">Qtd: ${i.qtd} <button onclick="remover(${i.id})" style="color:red; background:none; border:none; margin-left:10px">üóëÔ∏è</button></td>
            </tr>`;
        });
    }

    function remover(id) { estoque = estoque.filter(i => i.id !== id); salvar(); }

    function gerarRelatorioPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Relat√≥rio de Vendas", 14, 15);
        const rows = vendas.map(v => [v.data, v.item, v.qtd, `R$ ${v.total.toFixed(2)}`]);
        doc.autoTable({ head: [['Data', 'Item', 'Qtd', 'Total']], body: rows, startY: 25 });
        doc.save("relatorio.pdf");
    }

    function cancelarVenda() { document.getElementById('modal-venda').style.display = 'none'; }

    renderizar();
</script>
</body>
</html>
