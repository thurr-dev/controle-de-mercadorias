<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>PDV - Mini Adega com Recibo</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --bg: #0d0d0d; --card: #1a1a1a; --text: #eee; --primary: #3498db; --success: #2ecc71; --border: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; }
        
        #interactive.viewport { width: 100%; height: 250px; border: 2px solid var(--primary); display: none; border-radius: 15px; overflow: hidden; position: relative; background: #000; }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Linha de Scanner Animada para ajudar o foco */
        .laser { position: absolute; top: 50%; left: 10%; width: 80%; height: 2px; background: red; box-shadow: 0 0 10px red; z-index: 10; transform: translateY(-50%); animation: scan 2s infinite; }
        @keyframes scan { 0%, 100% { top: 30%; } 50% { top: 70%; } }

        #modal-venda { display: none; background: #1e1e1e; padding: 20px; border-radius: 12px; border: 2px solid var(--success); margin-top: 15px; text-align: center; }
        
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        input, button { padding: 14px; background: #252525; border: 1px solid var(--border); border-radius: 8px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
        .btn-blue { background: var(--primary); font-weight: bold; border: none; cursor: pointer; }
        .btn-green { background: var(--success); font-weight: bold; border: none; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        td { padding: 12px 0; border-bottom: 1px solid var(--border); }

        #toast { visibility: hidden; background: var(--success); color: #fff; text-align: center; border-radius: 8px; padding: 15px; position: fixed; z-index: 100; left: 50%; bottom: 20px; transform: translateX(-50%); }
        #toast.show { visibility: visible; }

        @media print {
            body * { visibility: hidden; }
            #cupom-print, #cupom-print * { visibility: visible; }
            #cupom-print { position: absolute; left: 0; top: 0; width: 100%; color: black; background: white; padding: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="toast">‚úÖ Opera√ß√£o Conclu√≠da!</div>
    <h2 style="text-align:center; color:var(--primary);">üè™ PDV - Mini Adega</h2>

    <button class="btn-blue" onclick="ligarScanner()">üì∑ ESCANEAR PRODUTO</button>
    <div id="interactive" class="viewport"><div class="laser"></div></div>

    <div id="modal-venda">
        <h3 id="venda-nome" style="color:var(--success); margin:0;">NOME</h3>
        <p id="venda-preco" style="color:#888;"></p>
        <input type="number" id="venda-qtd" value="1" min="1" style="text-align:center; font-size:24px;">
        <button class="btn-green" onclick="confirmarVenda()">CONFIRMAR VENDA</button>
        <button id="btn-imprimir" class="btn-blue" style="display:none;" onclick="imprimirCupom()">üñ®Ô∏è IMPRIMIR COMPROVANTE</button>
        <button onclick="cancelarVenda()" style="background:none; border:none; color:#777; cursor:pointer;">Fechar/Cancelar</button>
    </div>

    <div class="card">
        <h4>üì¶ Cadastro de Produto</h4>
        <input type="text" id="ean" placeholder="C√≥digo de Barras">
        <input type="text" id="nome" placeholder="Nome do Produto">
        <input type="number" id="estoque-inicial" placeholder="Qtd Estoque">
        <input type="number" id="preco-venda" placeholder="Pre√ßo R$">
        <button class="btn-blue" onclick="cadastrar()">CADASTRAR PRODUTO</button>
    </div>

    <div class="card">
        <h4>üìã Estoque</h4>
        <table><tbody id="listaProdutos"></tbody></table>
    </div>

    <div class="card">
        <h4>üìà Relat√≥rio Semanal</h4>
        <div style="height: 180px;"><canvas id="graficoVendas"></canvas></div>
        <button class="btn-blue" style="margin-top:20px;" onclick="gerarRelatorioPDF()">üìÑ BAIXAR RELAT√ìRIO MENSAL</button>
    </div>
</div>

<div id="cupom-print" style="display:none;"></div>

<script>
    let estoque = JSON.parse(localStorage.getItem('adega_v6_estoque')) || [];
    let vendas = JSON.parse(localStorage.getItem('adega_v6_vendas')) || [];
    let itemAtual = null;
    let ultimaVendaCupom = null;

    function somBip() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = 880; gain.gain.value = 0.1;
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function ligarScanner() {
        somBip();
        document.getElementById('interactive').style.display = 'block';
        document.getElementById('modal-venda').style.display = 'none';
        document.getElementById('btn-imprimir').style.display = 'none';

        Quagga.init({
            inputStream: { 
                name: "Live", 
                type: "LiveStream", 
                target: document.querySelector('#interactive'),
                constraints: {
                    width: { min: 1280 }, // For√ßa Alta Resolu√ß√£o
                    height: { min: 720 },
                    facingMode: "environment",
                    aspectRatio: { min: 1, max: 2 }
                }
            },
            locator: { patchSize: "medium", halfSample: false }, // Melhora localiza√ß√£o do c√≥digo
            decoder: { 
                readers: ["ean_reader", "upc_reader", "code_128_reader"],
                multiple: false 
            },
            locate: true
        }, err => { 
            if(!err) {
                Quagga.start();
                // Tenta for√ßar foco autom√°tico ap√≥s iniciar
                const track = Quagga.CameraAccess.getActiveTrack();
                if (track && typeof track.getCapabilities === 'function') {
                    const caps = track.getCapabilities();
                    if (caps.focusMode && caps.focusMode.includes('continuous')) {
                        track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
                    }
                }
            } 
        });
    }

    Quagga.onDetected(data => {
        const cod = data.codeResult.code;
        // Evita bips falsos (verifica se o c√≥digo tem um tamanho m√≠nimo comum)
        if (cod.length < 8) return;

        itemAtual = estoque.find(i => i.ean === cod);
        somBip(); 
        Quagga.stop();
        document.getElementById('interactive').style.display = 'none';
        
        if(itemAtual) {
            document.getElementById('modal-venda').style.display = 'block';
            document.getElementById('venda-nome').innerText = itemAtual.nome;
            document.getElementById('venda-preco').innerText = "R$ " + itemAtual.preco.toFixed(2);
            document.getElementById('venda-qtd').value = 1;
            document.getElementById('venda-qtd').focus();
        } else {
            document.getElementById('ean').value = cod;
            alert("C√≥digo: " + cod + "\nProduto n√£o cadastrado!");
        }
    });

    function confirmarVenda() {
        const qtd = parseInt(document.getElementById('venda-qtd').value);
        if(itemAtual && itemAtual.qtd >= qtd) {
            itemAtual.qtd -= qtd;
            ultimaVendaCupom = {
                data: new Date().toLocaleString(),
                item: itemAtual.nome,
                qtd: qtd,
                preco: itemAtual.preco,
                total: itemAtual.preco * qtd
            };
            vendas.push({ data: new Date().toLocaleDateString(), item: itemAtual.nome, qtd: qtd, total: itemAtual.preco * qtd });
            salvarTudo();
            document.getElementById('btn-imprimir').style.display = 'block';
            mostrarSucesso("Venda confirmada!");
        } else { alert("Estoque baixo ou item n√£o selecionado!"); }
    }

    function imprimirCupom() {
        if(!ultimaVendaCupom) return;
        const cupom = `
            <div style="text-align:center; font-family:monospace;">
                <h3>MINI ADEGA</h3>
                <p>--------------------------</p>
                <p>COMPROVANTE DE VENDA</p>
                <p>${ultimaVendaCupom.data}</p>
                <p>--------------------------</p>
                <div style="text-align:left;">
                    <p>ITEM: ${ultimaVendaCupom.item}</p>
                    <p>QTD: ${ultimaVendaCupom.qtd} x R$ ${ultimaVendaCupom.preco.toFixed(2)}</p>
                    <p><strong>TOTAL: R$ ${ultimaVendaCupom.total.toFixed(2)}</strong></p>
                </div>
                <p>--------------------------</p>
                <p>Obrigado pela prefer√™ncia!</p>
            </div>
        `;
        const areaPrint = document.getElementById('cupom-print');
        areaPrint.innerHTML = cupom;
        window.print();
    }

    function cancelarVenda() { document.getElementById('modal-venda').style.display = 'none'; itemAtual = null; }

    function cadastrar() {
        const item = { id: Date.now(), ean: document.getElementById('ean').value, nome: document.getElementById('nome').value, qtd: parseInt(document.getElementById('estoque-inicial').value) || 0, preco: parseFloat(document.getElementById('preco-venda').value) || 0 };
        if(!item.nome || !item.ean) return alert("Preencha tudo!");
        estoque.push(item);
        salvarTudo();
        mostrarSucesso("Cadastrado!");
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function mostrarSucesso(msg) { const t = document.getElementById('toast'); t.innerText = "‚úÖ " + msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }
    function salvarTudo() { localStorage.setItem('adega_v6_estoque', JSON.stringify(estoque)); localStorage.setItem('adega_v6_vendas', JSON.stringify(vendas)); renderizar(); atualizarGrafico(); }
    
    function renderizar() {
        const corpo = document.getElementById('listaProdutos');
        corpo.innerHTML = '';
        estoque.forEach(i => {
            corpo.innerHTML += `<tr><td><strong>${i.nome}</strong><br><small>${i.ean}</small></td><td style="text-align:center">${i.qtd}</td><td style="text-align:right">R$ ${i.preco.toFixed(2)}</td></tr>`;
        });
    }

    let chart;
    function atualizarGrafico() {
        const ctx = document.getElementById('graficoVendas').getContext('2d');
        const dias = Array.from({length: 7}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return d.toLocaleDateString(); }).reverse();
        const dados = dias.map(dia => vendas.filter(v => v.data === dia).reduce((acc, v) => acc + v.total, 0));
        if(chart) chart.destroy();
        chart = new Chart(ctx, { type: 'line', data: { labels: dias, datasets: [{ label: 'Vendas R$', data: dados, borderColor: '#3498db', fill: true, backgroundColor: 'rgba(52, 152, 219, 0.1)' }] }, options: { maintainAspectRatio: false } });
    }

    function gerarRelatorioPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Relat√≥rio de Vendas", 14, 20);
        const rows = vendas.map(v => [v.data, v.item, v.qtd, `R$ ${v.total.toFixed(2)}`]);
        doc.autoTable({ head: [['Data', 'Produto', 'Qtd', 'Total']], body: rows, startY: 30 });
        doc.save("relatorio.pdf");
    }

    renderizar(); atualizarGrafico();
</script>
</body>
</html>
