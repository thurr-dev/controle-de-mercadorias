<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Profissional - Scanner & Bip</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #eee; --primary: #3498db; --success: #2ecc71; --border: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        
        /* Ajuste do Scanner */
        #interactive.viewport { width: 100%; height: 250px; border: 2px solid var(--primary); display: none; border-radius: 15px; overflow: hidden; position: relative; background: #000; }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
        .laser { position: absolute; top: 50%; left: 50%; width: 80%; height: 2px; background: red; transform: translate(-50%, -50%); box-shadow: 0 0 10px red; z-index: 10; }

        #modal-venda { display: none; background: #222; padding: 20px; border-radius: 12px; border: 2px solid var(--success); margin-top: 15px; text-align: center; }
        
        input, button { padding: 14px; background: #252525; border: 1px solid var(--border); border-radius: 8px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
        .btn-blue { background: var(--primary); font-weight: bold; border: none; cursor: pointer; }
        .btn-green { background: var(--success); font-weight: bold; border: none; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; color: #888; padding-bottom: 10px; }
        td { padding: 10px 0; border-bottom: 1px solid var(--border); }

        #toast { visibility: hidden; background: var(--success); color: #fff; text-align: center; border-radius: 8px; padding: 15px; position: fixed; z-index: 100; left: 50%; bottom: 20px; transform: translateX(-50%); }
        #toast.show { visibility: visible; }
    </style>
</head>
<body>

<div class="container">
    <div id="toast">‚úÖ Conclu√≠do!</div>
    <h2 style="text-align:center; color:var(--primary);">üè™ Gest√£o de Estoque</h2>

    <button class="btn-blue" onclick="iniciarVenda()">üì∑ ESCANEAR PARA VENDER</button>
    
    <div id="interactive" class="viewport">
        <div class="laser"></div>
    </div>

    <div id="modal-venda">
        <h3 id="venda-nome" style="color:var(--success); margin:0;">NOME</h3>
        <p id="venda-preco" style="color:#888;"></p>
        <label>Quantidade:</label>
        <input type="number" id="venda-qtd" value="1" min="1" style="text-align:center; font-size:20px;">
        <button class="btn-green" onclick="confirmarBaixa()">CONFIRMAR VENDA</button>
        <button onclick="cancelarVenda()" style="background:none; border:none; color:#777; margin-top:10px; cursor:pointer;">Cancelar</button>
    </div>

    <div class="card">
        <h4>üì¶ Cadastro de Produto</h4>
        <input type="text" id="ean" placeholder="C√≥digo de Barras">
        <input type="text" id="nome" placeholder="Nome do Produto">
        <input type="number" id="estoque-inicial" placeholder="Qtd em Estoque">
        <input type="number" id="preco-venda" placeholder="Pre√ßo de Venda R$">
        <button class="btn-blue" onclick="cadastrar()">CADASTRAR PRODUTO</button>
    </div>

    <div class="card">
        <h4>üìã Estoque & Validade</h4>
        <table>
            <thead><tr><th>Item</th><th>Qtd</th><th>A√ß√µes</th></tr></thead>
            <tbody id="listaProdutos"></tbody>
        </table>
    </div>

    <div class="card">
        <h4>üìà Relat√≥rio Semanal</h4>
        <div style="height: 200px;"><canvas id="graficoVendas"></canvas></div>
        <button class="btn-blue" style="margin-top:20px;" onclick="gerarRelatorioPDF()">üìä BAIXAR RELAT√ìRIO MENSAL</button>
    </div>
</div>

<script>
    let estoque = JSON.parse(localStorage.getItem('loja_estoque')) || [];
    let historicoVendas = JSON.parse(localStorage.getItem('loja_vendas')) || [];
    let produtoEncontrado = null;

    // --- FUN√á√ÉO DO BIP CORRIGIDA ---
    function tocarBip() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // Nota L√°
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1); // Dura√ß√£o de 100ms
        } catch (e) {
            console.log("Erro ao tocar som: ", e);
        }
    }

    function iniciarVenda() {
        // Tocar um bip silencioso para "desbloquear" o √°udio no navegador
        tocarBip();
        abrirScanner();
    }

    function abrirScanner() {
        document.getElementById('interactive').style.display = 'block';
        document.getElementById('modal-venda').style.display = 'none';

        Quagga.init({
            inputStream: { 
                name: "Live", 
                type: "LiveStream", 
                target: document.querySelector('#interactive'),
                constraints: { facingMode: "environment", focusMode: "continuous" }
            },
            decoder: { readers: ["ean_reader"] },
            locate: true
        }, err => {
            if(!err) Quagga.start();
        });
    }

    Quagga.onDetected(data => {
        const cod = data.codeResult.code;
        produtoEncontrado = estoque.find(i => i.ean === cod);

        if(produtoEncontrado) {
            tocarBip(); // SOM DO BIP NO SUCESSO
            Quagga.stop();
            document.getElementById('interactive').style.display = 'none';
            document.getElementById('modal-venda').style.display = 'block';
            document.getElementById('venda-nome').innerText = produtoEncontrado.nome;
            document.getElementById('venda-preco').innerText = "R$ " + produtoEncontrado.preco.toFixed(2);
            document.getElementById('venda-qtd').value = 1;
        } else {
            document.getElementById('ean').value = cod;
        }
    });

    function confirmarBaixa() {
        const qtd = parseInt(document.getElementById('venda-qtd').value);
        if(produtoEncontrado.qtd >= qtd) {
            produtoEncontrado.qtd -= qtd;
            historicoVendas.push({
                data: new Date().toLocaleDateString(),
                item: produtoEncontrado.nome,
                qtd: qtd,
                total: produtoEncontrado.preco * qtd
            });
            salvar();
            cancelarVenda();
            mostrarToast("Venda Conclu√≠da!");
        } else {
            alert("Estoque insuficiente! Dispon√≠vel: " + produtoEncontrado.qtd);
        }
    }

    function cancelarVenda() {
        document.getElementById('modal-venda').style.display = 'none';
        produtoEncontrado = null;
    }

    function cadastrar() {
        const item = {
            id: Date.now(),
            ean: document.getElementById('ean').value,
            nome: document.getElementById('nome').value,
            qtd: parseInt(document.getElementById('estoque-inicial').value) || 0,
            preco: parseFloat(document.getElementById('preco-venda').value) || 0
        };
        if(!item.nome || !item.ean) return alert("Preencha os campos!");
        estoque.push(item);
        salvar();
        mostrarToast("Produto Cadastrado!");
        document.querySelectorAll('input').forEach(i => i.value = '');
    }

    function mostrarToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = "‚úÖ " + msg;
        t.className = "show";
        setTimeout(() => t.className = "", 3000);
    }

    function salvar() {
        localStorage.setItem('loja_estoque', JSON.stringify(estoque));
        localStorage.setItem('loja_vendas', JSON.stringify(historicoVendas));
        renderizar();
        atualizarGrafico();
    }

    function renderizar() {
        const corpo = document.getElementById('listaProdutos');
        corpo.innerHTML = '';
        estoque.forEach(i => {
            corpo.innerHTML += `<tr>
                <td><strong>${i.nome}</strong><br><small>${i.ean}</small></td>
                <td>${i.qtd}</td>
                <td><button onclick="remover(${i.id})" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:18px;">üóëÔ∏è</button></td>
            </tr>`;
        });
    }

    function remover(id) {
        if(confirm("Deseja excluir este produto?")) {
            estoque = estoque.filter(i => i.id !== id);
            salvar();
        }
    }

    let chart;
    function atualizarGrafico() {
        const ctx = document.getElementById('graficoVendas').getContext('2d');
        const dias = Array.from({length: 7}, (_, i) => {
            const d = new Date(); d.setDate(d.getDate() - i);
            return d.toLocaleDateString();
        }).reverse();

        const dados = dias.map(dia => {
            return historicoVendas.filter(v => v.data === dia).reduce((acc, v) => acc + v.total, 0);
        });

        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: dias, datasets: [{ label: 'Vendas (R$)', data: dados, backgroundColor: '#3498db', borderRadius: 5 }] },
            options: { maintainAspectRatio: false, scales: { y: { grid: { color: '#333' }, ticks: { color: '#888' } }, x: { ticks: { color: '#888' } } }, plugins: { legend: { display: false } } }
        });
    }

    function gerarRelatorioPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("Relat√≥rio Mensal de Vendas", 14, 20);
        
        const rows = historicoVendas.map(v => [v.data, v.item, v.qtd, `R$ ${v.total.toFixed(2)}`]);
        const totalGeral = historicoVendas.reduce((acc, v) => acc + v.total, 0);

        doc.autoTable({
            head: [['Data', 'Produto', 'Qtd', 'Total']],
            body: rows,
            startY: 30,
            theme: 'grid'
        });

        doc.text(`Total Acumulado: R$ ${totalGeral.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
        doc.save("relatorio_vendas_adega.pdf");
    }

    renderizar();
    atualizarGrafico();
</script>
</body>
</html>
