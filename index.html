<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Mini Adega - Profissional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f0f0f; --card: #1a1a1a; --text: #f0f0f0;
            --primary: #3498db; --success: #27ae60; --danger: #e74c3c;
            --accent: #f1c40f; --border: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; }
        
        /* Notifica√ß√£o de Conclu√≠do */
        #toast { 
            visibility: hidden; min-width: 250px; background-color: var(--success); color: white; 
            text-align: center; border-radius: 8px; padding: 16px; position: fixed; 
            z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: bold;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        /* Scanner e Identifica√ß√£o */
        #interactive.viewport { width: 100%; height: 200px; border: 2px solid var(--primary); display: none; margin-bottom: 15px; border-radius: 12px; overflow: hidden; }
        #info-scan { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none; border-left: 5px solid var(--accent); }

        /* Layout */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        input, select, button { padding: 12px; background: #252525; border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 14px; }
        .btn-main { background: var(--primary); font-weight: bold; border: none; cursor: pointer; }
        .btn-venda { background: var(--success); font-weight: bold; border: none; width: 100%; margin-top: 10px; }

        /* Carrinho e Vendas */
        .painel-checkout { background: #1b2e23; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--success); }
        .item-carrinho { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #2d5a3f; font-size: 0.9em; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #777; padding: 10px; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<div class="container">
    <div id="toast">‚úÖ Produto Cadastrado com Sucesso!</div>

    <h2 style="text-align:center; color:var(--primary)">üè™ PDV Mini Adega Pr√≥</h2>

    <button class="btn-main" style="width:100%; margin-bottom:10px;" onclick="toggleScanner()">üì∑ ABRIR C√ÇMERA PARA VENDA / CADASTRO</button>
    <div id="interactive" class="viewport"></div>

    <div id="info-scan">
        <span style="color:var(--accent); font-size:0.8em;">PRODUTO IDENTIFICADO:</span><br>
        <strong id="scan-nome">---</strong> | <span id="scan-preco">R$ 0,00</span>
    </div>

    <div class="painel-checkout" id="painelCarrinho" style="display:none;">
        <h4 style="margin-top:0;">üõí Itens na Venda:</h4>
        <div id="listaCarrinho"></div>
        <div style="margin-top:10px; border-top: 1px solid var(--success); padding-top:10px; font-weight:bold;">
            TOTAL: <span id="totalCarrinho" style="color:var(--success); font-size:1.2em;">R$ 0,00</span>
        </div>
        <button class="btn-venda" onclick="finalizarVenda()">CONCLUIR VENDA (SUBTRAIR ESTOQUE)</button>
    </div>

    <div class="card">
        <h4 style="margin:0 0 10px 0;">üì¶ Cadastro R√°pido</h4>
        <div class="form-grid">
            <input type="text" id="ean" placeholder="C√≥digo de Barras">
            <input type="text" id="nome" placeholder="Nome do Produto">
            <input type="number" id="qtd" placeholder="Estoque">
            <input type="number" id="preco" placeholder="Pre√ßo R$">
            <button class="btn-main" onclick="cadastrar()">SALVAR PRODUTO</button>
        </div>
    </div>

    <div class="card">
        <h4 style="margin:0 0 10px 0;">üìã Estoque Registrado</h4>
        <input type="text" id="busca" placeholder="üîç Pesquisar no estoque..." onkeyup="renderizar()" style="width:100%; margin-bottom:10px;">
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>Produto</th><th>Qtd</th><th>Pre√ßo</th><th>A√ß√£o</th></tr></thead>
                <tbody id="tabelaEstoque"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let estoque = JSON.parse(localStorage.getItem('mini_estoque_v3')) || [];
    let carrinho = [];

    function tocarBip() {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const osc = context.createOscillator();
        const gain = context.createGain();
        osc.type = "sine"; osc.frequency.setValueAtTime(900, context.currentTime);
        gain.gain.setValueAtTime(0.1, context.currentTime);
        osc.connect(gain); gain.connect(context.destination);
        osc.start(); osc.stop(context.currentTime + 0.1);
    }

    function mostrarToast() {
        const x = document.getElementById("toast");
        x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }

    function toggleScanner() {
        const div = document.getElementById('interactive');
        if (div.style.display === 'block') { Quagga.stop(); div.style.display = 'none'; }
        else {
            div.style.display = 'block';
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: div, constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader", "upc_reader", "code_128_reader"] }
            }, err => { if(!err) Quagga.start(); });
        }
    }

    Quagga.onDetected(data => {
        const cod = data.codeResult.code;
        tocarBip();
        const item = estoque.find(i => i.ean === cod);

        if(item) {
            // Identifica√ß√£o do produto na hora da venda
            document.getElementById('info-scan').style.display = 'block';
            document.getElementById('scan-nome').innerText = item.nome;
            document.getElementById('scan-preco').innerText = `R$ ${item.preco.toFixed(2)}`;
            
            // Adiciona ao carrinho tempor√°rio
            carrinho.push(item);
            atualizarCarrinho();
        } else {
            document.getElementById('ean').value = cod;
            alert("Produto n√£o cadastrado! C√≥digo copiado para o formul√°rio.");
        }
    });

    function atualizarCarrinho() {
        const lista = document.getElementById('listaCarrinho');
        const painel = document.getElementById('painelCarrinho');
        lista.innerHTML = '';
        let total = 0;

        if(carrinho.length > 0) painel.style.display = 'block';

        carrinho.forEach((item, index) => {
            total += item.preco;
            lista.innerHTML += `
                <div class="item-carrinho">
                    <span>${item.nome}</span>
                    <strong>R$ ${item.preco.toFixed(2)} <span onclick="removerCarrinho(${index})" style="color:var(--danger); cursor:pointer; margin-left:10px;">‚úñ</span></strong>
                </div>`;
        });
        document.getElementById('totalCarrinho').innerText = `R$ ${total.toFixed(2)}`;
    }

    function removerCarrinho(index) {
        carrinho.splice(index, 1);
        if(carrinho.length === 0) document.getElementById('painelCarrinho').style.display = 'none';
        atualizarCarrinho();
    }

    function finalizarVenda() {
        carrinho.forEach(itemCarrinho => {
            const itemEstoque = estoque.find(i => i.id === itemCarrinho.id);
            if(itemEstoque && itemEstoque.qtd > 0) itemEstoque.qtd--;
        });
        carrinho = [];
        document.getElementById('painelCarrinho').style.display = 'none';
        document.getElementById('info-scan').style.display = 'none';
        salvar();
        alert("Venda Conclu√≠da com Sucesso!");
    }

    function cadastrar() {
        const item = {
            id: Date.now(),
            ean: document.getElementById('ean').value,
            nome: document.getElementById('nome').value,
            qtd: parseInt(document.getElementById('qtd').value) || 0,
            preco: parseFloat(document.getElementById('preco').value) || 0
        };
        if(!item.nome || !item.ean) return alert("Preencha Nome e C√≥digo!");
        estoque.push(item);
        salvar();
        mostrarToast();
        limpar();
    }

    function salvar() {
        localStorage.setItem('mini_estoque_v3', JSON.stringify(estoque));
        renderizar();
    }

    function renderizar() {
        const busca = document.getElementById('busca').value.toLowerCase();
        const corpo = document.getElementById('tabelaEstoque');
        corpo.innerHTML = '';

        estoque.filter(i => i.nome.toLowerCase().includes(busca) || i.ean.includes(busca)).forEach(i => {
            corpo.innerHTML += `
                <tr>
                    <td><strong>${i.nome}</strong><br><small style="color:#666">${i.ean}</small></td>
                    <td>${i.qtd}</td>
                    <td style="color:var(--success)">R$ ${i.preco.toFixed(2)}</td>
                    <td><button onclick="removerEstoque(${i.id})" style="border:none; background:none; color:var(--danger); cursor:pointer;">üóëÔ∏è</button></td>
                </tr>`;
        });
    }

    function removerEstoque(id) { if(confirm("Remover do estoque?")) { estoque = estoque.filter(i => i.id !== id); salvar(); } }
    function limpar() { document.querySelectorAll('input').forEach(i => i.value = ''); }

    renderizar();
</script>
</body>
</html>
