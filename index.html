<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adega Pro PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081840.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --text: #eee; --primary: #3498db; --success: #2ecc71; --border: #333; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 50px; }
        .container { max-width: 600px; margin: auto; }
        
        #interactive.viewport { width: 100%; height: 300px; border: 2px solid var(--primary); display: none; border-radius: 15px; overflow: hidden; position: relative; background: #000; margin-bottom: 15px; }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
        canvas.drawingBuffer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        input, button { padding: 14px; background: #222; border: 1px solid var(--border); border-radius: 8px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
        .btn-blue { background: var(--primary); font-weight: bold; border: none; cursor: pointer; }
        .btn-green { background: var(--success); font-weight: bold; border: none; cursor: pointer; }
        
        #modal-venda { display: none; background: #222; padding: 20px; border-radius: 12px; border: 2px solid var(--success); text-align: center; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 12px 5px; border-bottom: 1px solid #333; font-size: 14px; }
        .btn-cal { color: var(--warning); border: 1px solid var(--warning); padding: 4px 8px; text-decoration: none; display: inline-block; font-size: 11px; border-radius: 4px; margin-top: 5px; }

        #toast { visibility: hidden; background: var(--success); color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: bold; }
        #toast.show { visibility: visible; animation: fadein 0.3s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    </style>
</head>
<body>

<div class="container">
    <div id="toast">‚úÖ Conclu√≠do!</div>
    <h2 style="text-align:center; color:var(--primary);">üè™ Adega Pro PWA</h2>

    <button class="btn-blue" onclick="abrirScanner()">üì∑ ESCANEAR C√ìDIGO</button>
    <div id="interactive" class="viewport"></div>

    <div id="modal-venda" class="card">
        <h3 id="venda-nome" style="color:var(--success); margin:0;"></h3>
        <p id="venda-preco" style="color:#888;"></p>
        <label>Quantidade:</label>
        <input type="number" id="venda-qtd" value="1" min="1" style="text-align:center; font-size:22px;">
        <button class="btn-green" onclick="confirmarBaixa()">CONFIRMAR VENDA</button>
        <button onclick="cancelarVenda()" style="background:none; border:none; color:#777; cursor:pointer;">Cancelar</button>
    </div>

    <div class="card">
        <h4>üì¶ Cadastro</h4>
        <input type="text" id="ean" placeholder="C√≥digo EAN">
        <input type="text" id="nome" placeholder="Produto">
        <input type="number" id="estoque-inicial" placeholder="Estoque">
        <input type="number" id="preco-venda" placeholder="Pre√ßo R$">
        <input type="date" id="vencimento">
        <button class="btn-blue" onclick="cadastrar()">SALVAR</button>
    </div>

    <div class="card">
        <h4>üìã Estoque</h4>
        <table id="listaProdutos"></table>
    </div>

    <div class="card">
        <h4>üìä Relat√≥rio Semanal</h4>
        <div style="height: 180px;"><canvas id="graficoVendas"></canvas></div>
        <button class="btn-blue" style="margin-top:20px;" onclick="gerarRelatorioPDF()">üìÑ EXPORTAR PDF</button>
    </div>
</div>

<script>
    // Registro do Service Worker para PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    let estoque = JSON.parse(localStorage.getItem('adega_pwa_v1')) || [];
    let vendas = JSON.parse(localStorage.getItem('vendas_pwa_v1')) || [];
    let produtoEncontrado = null;

    function abrirScanner() {
        const scannerDiv = document.getElementById('interactive');
        scannerDiv.style.display = 'block';
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: scannerDiv, constraints: { facingMode: "environment" } },
            locator: { patchSize: "medium", halfSample: true },
            decoder: { readers: ["ean_reader"] },
            locate: true
        }, (err) => { if (!err) Quagga.start(); });
    }

    Quagga.onDetected((data) => {
        const code = data.codeResult.code;
        produtoEncontrado = estoque.find(i => i.ean === code);
        if (produtoEncontrado) {
            Quagga.stop();
            document.getElementById('interactive').style.display = 'none';
            document.getElementById('modal-venda').style.display = 'block';
            document.getElementById('venda-nome').innerText = produtoEncontrado.nome;
            document.getElementById('venda-preco').innerText = "R$ " + produtoEncontrado.preco.toFixed(2);
        } else { document.getElementById('ean').value = code; }
    });

    function cadastrar() {
        const item = { id: Date.now(), ean: document.getElementById('ean').value, nome: document.getElementById('nome').value, qtd: parseInt(document.getElementById('estoque-inicial').value) || 0, preco: parseFloat(document.getElementById('preco-venda').value) || 0, vencimento: document.getElementById('vencimento').value };
        estoque.push(item);
        salvar();
        mostrarToast();
        limpar();
    }

    function confirmarBaixa() {
        const qtd = parseInt(document.getElementById('venda-qtd').value);
        if (produtoEncontrado.qtd >= qtd) {
            produtoEncontrado.qtd -= qtd;
            vendas.push({ data: new Date().toLocaleDateString(), item: produtoEncontrado.nome, qtd, total: produtoEncontrado.preco * qtd });
            salvar();
            cancelarVenda();
            mostrarToast();
        } else { alert("Estoque insuficiente!"); }
    }

    function salvar() {
        localStorage.setItem('adega_pwa_v1', JSON.stringify(estoque));
        localStorage.setItem('vendas_pwa_v1', JSON.stringify(vendas));
        renderizar();
        atualizarGrafico();
    }

    function renderizar() {
        const corpo = document.getElementById('listaProdutos');
        corpo.innerHTML = '';
        estoque.forEach(i => {
            const dataBr = i.vencimento ? i.vencimento.split('-').reverse().join('/') : '---';
            const linkCal = i.vencimento ? `<a href="https://www.google.com/calendar/render?action=TEMPLATE&text=VENCIMENTO:+${encodeURIComponent(i.nome)}&dates=${i.vencimento.replace(/-/g,'')}/${i.vencimento.replace(/-/g,'')}" target="_blank" class="btn-cal">üìÖ Alerta</a>` : '';
            corpo.innerHTML += `<tr><td><strong>${i.nome}</strong><br><small>Venc: ${dataBr}</small><br>${linkCal}</td><td style="text-align:right">Qtd: ${i.qtd} <button onclick="remover(${i.id})" style="background:none; border:none; color:red; cursor:pointer; margin-left:10px;">üóëÔ∏è</button></td></tr>`;
        });
    }

    function mostrarToast() { const t = document.getElementById('toast'); t.className = "show"; setTimeout(() => t.className = "", 3000); }
    function remover(id) { if(confirm("Excluir?")) { estoque = estoque.filter(i => i.id !== id); salvar(); } }
    function cancelarVenda() { document.getElementById('modal-venda').style.display = 'none'; }
    function limpar() { document.querySelectorAll('input').forEach(i => i.value = ''); }

    function gerarRelatorioPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const rows = vendas.map(v => [v.data, v.item, v.qtd, `R$ ${v.total.toFixed(2)}`]);
        doc.text("Relat√≥rio Adega Pro", 14, 15);
        doc.autoTable({ head: [['Data', 'Item', 'Qtd', 'Total']], body: rows, startY: 25 });
        doc.save("relatorio_vendas.pdf");
    }

    let myChart;
    function atualizarGrafico() {
        const ctx = document.getElementById('graficoVendas').getContext('2d');
        const dias = Array.from({length: 7}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return d.toLocaleDateString(); }).reverse();
        const dados = dias.map(d => vendas.filter(v => v.data === d).reduce((acc, v) => acc + v.total, 0));
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'bar', data: { labels: dias, datasets: [{ label: 'Vendas R$', data: dados, backgroundColor: '#3498db' }] }, options: { maintainAspectRatio: false, scales: { y: { grid: { color: '#333' } }, x: { grid: { color: '#333' } } } } });
    }

    renderizar();
    atualizarGrafico();
</script>
</body>
</html>
